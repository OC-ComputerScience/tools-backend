name: Deploy to Windows Prod

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  windows-deploy:
    if: github.event.pull_request.merged == true
    runs-on: windows-latest
    env:
      DB_HOST: ${{ secrets.PROD_DB_HOST }}
      DB_PW: ${{ secrets.PROD_DB_PW}}
      DB_USER: ${{ secrets.PROD_DB_USER }}
      DB_NAME: ${{ secrets.PROD_DB_NAME }}
      CLIENT_ID: ${{secrets.CLIENT_ID}}
      CLIENT_SECRET: ${{secrets.CLIENT_SECRET}}
      PORT: ${{secrets.PORT}}
      GEMINI_API_KEY: ${{secrets.GEMINI_API_KEY}}
      CANVAS_DOMAIN: ${{secrets.PROD_CANVAS_DOMAIN}}
      CANVAS_API_TOKEN: ${{secrets.PROD_CANVAS_API_TOKEN}}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      - uses: actions/setup-node@v4
        with:
          node-version: "20.11.0"

      - run: |
          "DB_HOST=${{env.DB_HOST}}" | Out-File -FilePath .env -Encoding utf8
          "DB_PW=${{env.DB_PW}}" | Out-File -FilePath .env -Append -Encoding utf8
          "DB_USER=${{env.DB_USER}}" | Out-File -FilePath .env -Append -Encoding utf8
          "DB_NAME=${{env.DB_NAME}}" | Out-File -FilePath .env -Append -Encoding utf8
          "CLIENT_ID=${{env.CLIENT_ID}}" | Out-File -FilePath .env -Append -Encoding utf8
          "CLIENT_SECRET=${{env.CLIENT_SECRET}}" | Out-File -FilePath .env -Append -Encoding utf8
          "PORT=${{env.PORT}}" | Out-File -FilePath .env -Append -Encoding utf8
          "GEMINI_API_KEY=${{env.GEMINI_API_KEY}}" | Out-File -FilePath .env -Append -Encoding utf8
          "CANVAS_DOMAIN=${{env.CANVAS_DOMAIN}}" | Out-File -FilePath .env -Append -Encoding utf8
          "CANVAS_API_TOKEN=${{env.CANVAS_API_TOKEN}}" | Out-File -FilePath .env -Append -Encoding utf8

      - run: npm run winbundle
      - name: Copy folder content recursively to remote
        uses: garygrossgarten/github-action-scp@release
        with:
          local: deploy/
          remote: c:/nodeapps/tools-backend
          recursive: true
          host: "tools.oc.edu"
          username: "david.north"
          privateKey: ${{ secrets.PROD_WIN_SERVER_SSH_KEY  }}
          password: ${{ secrets.PASSWORD }}

      - name: Command via ssh
        uses: garygrossgarten/github-action-ssh@release
        with:
          command: '.\deploy-tools-backend'
          host: "tools.oc.edu"
          username: "david.north"
          privateKey: ${{ secrets.PROD_WIN_SERVER_SSH_KEY  }}
